<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Property Management System - Tenant Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

  <!-- ✅ Bootstrap 5 CSS (needed for the modal) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    /* your existing styles unchanged */
    :root { --primary:#2563eb; --primary-dark:#1d4ed8; --secondary:#6b7280; --white:#ffffff; --black:#000000;
      --bg-main:#ffffff; --bg-sidebar:#000000; --bg-card:#ffffff; --text-primary:#000000; --text-secondary:#6b7280;
      --text-light:#9ca3af; --text-white:#ffffff; --border-color:#e5e7eb; --shadow-sm:0 1px 3px rgba(0,0,0,0.12);
      --shadow-md:0 4px 6px rgba(0,0,0,0.1); --shadow-lg:0 10px 15px rgba(0,0,0,0.1); --sidebar-width:280px;
      --header-height:80px; --border-radius:8px; }
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background-color:var(--bg-main);color:var(--text-primary);line-height:1.6;overflow-x:hidden}
    .sidebar{position:fixed;width:var(--sidebar-width);height:100vh;background:var(--bg-sidebar);color:var(--text-white);padding:1.5rem 0;z-index:1000;transition:transform .3s ease}
    .main-content{margin-left:var(--sidebar-width);min-height:100vh;padding:0}
    .sidebar-header{padding:0 1.5rem 1.5rem;border-bottom:1px solid rgba(255,255,255,.1)}
    .logo{display:flex;align-items:center;gap:.75rem;font-size:1.5rem;font-weight:700;margin-bottom:.5rem}
    .logo i{color:var(--primary);font-size:1.8rem}
    .subtitle{font-size:.85rem;color:var(--text-light);margin-left:2.5rem}
    .sidebar-nav{margin-top:1.5rem}
    .nav-section{margin-bottom:1.5rem}
    .nav-label{font-size:.75rem;text-transform:uppercase;color:var(--text-light);padding:0 1.5rem;margin-bottom:.75rem;letter-spacing:.5px}
    .nav-item{display:flex;align-items:center;padding:.85rem 1.5rem;color:var(--text-light);text-decoration:none;transition:all .3s ease;position:relative;cursor:pointer}
    .nav-item:hover,.nav-item.active{background:rgba(255,255,255,.1);color:var(--text-white)}
    .nav-item i{width:1.5rem;margin-right:.75rem;font-size:1.1rem}
    .sign-out{margin-top:2rem;border-top:1px solid rgba(255,255,255,.1);padding-top:1rem}
    .header{display:flex;justify-content:space-between;align-items:center;padding:1rem 2rem;background:var(--bg-card);box-shadow:var(--shadow-sm);height:var(--header-height)}
    .header-left h1{font-size:1.5rem;font-weight:600;margin-bottom:.25rem}
    .header-left p{color:var(--text-secondary);font-size:.9rem}
    .header-right{display:flex;align-items:center;gap:1rem}
    .user-profile{width:40px;height:40px;border-radius:50%;background:var(--primary);color:var(--text-white);display:flex;align-items:center;justify-content:center;font-weight:600;cursor:pointer;text-decoration:none}
    .dashboard-content{padding:2rem}
    .toolbar{display:flex;gap:1rem;margin-bottom:2rem;align-items:center}
    input[type="search"]{flex:1;padding:.75rem;border:1px solid var(--border-color);border-radius:var(--border-radius);font-size:1rem}
    input[type="search"]:focus{outline:none;border-color:var(--primary)}
    select{padding:.75rem;border:1px solid var(--border-color);border-radius:var(--border-radius);background:var(--bg-card);font-size:1rem}
    select:focus{outline:none;border-color:var(--primary)}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1.5rem}
    .card{background:var(--bg-card);border-radius:var(--border-radius);padding:1.5rem;box-shadow:var(--shadow-sm);transition:transform .3s ease,box-shadow .3s ease}
    .card:hover{transform:translateY(-5px);box-shadow:var(--shadow-md)}
    .card h3{margin:0 0 .5rem;font-size:1.2rem;font-weight:600}
    .muted{color:var(--text-secondary);font-size:.9rem}
    .price{font-weight:700;margin-top:.75rem;color:var(--primary);font-size:1.1rem}
    .imgwrap{width:100%;aspect-ratio:4/3;overflow:hidden;border-radius:calc(var(--border-radius) - 2px);background:#f3f4f6;margin-bottom:1rem;display:flex;align-items:center;justify-content:center}
    .imgwrap img{width:100%;height:100%;object-fit:cover;display:block}
    .empty{text-align:center;padding:3rem 1rem;color:var(--text-secondary);font-size:1.1rem}
    @media (max-width:992px){.sidebar{transform:translateX(-100%);width:280px}.sidebar.active{transform:translateX(0)}.main-content{margin-left:0}.menu-toggle{display:block;position:fixed;top:1rem;left:1rem;z-index:1100;background:var(--primary);color:var(--text-white);width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:var(--shadow-md);border:none}}
    @media (max-width:768px){.header{flex-direction:column;align-items:flex-start;height:auto;padding:1rem}.header-right{margin-top:1rem;width:100%;justify-content:space-between}.dashboard-content{padding:1rem}.toolbar{flex-direction:column;gap:.75rem}.grid{grid-template-columns:1fr}}
    .menu-toggle{display:none}
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="sidebar-header">
      <div class="logo"><i class="fas fa-building"></i><span>Property</span></div>
      <div class="subtitle">Management System</div>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-section">
        <div class="nav-label">TENANT PORTAL</div>
        <a href="./tenantdashboard.html" class="nav-item active"><i class="fas fa-chart-pie"></i><span>Dashboard</span></a>
        <a href="./tenant-issues.html" class="nav-item"><i class="fas fa-tools"></i><span>Issues</span></a>
        <a href="./tenant-chat.html" class="nav-item"><i class="fas fa-envelope"></i><span>Chat</span></a>
        <div class="sign-out">
          <a href="./index.html" class="nav-item" id="logoutBtn"><i class="fas fa-sign-out-alt"></i><span>Sign Out</span></a>
        </div>
      </div>
    </nav>
  </div>

  <div class="main-content">
    <header class="header">
      <div class="header-left">
        <h1>Dashboard</h1>
        <p>Welcome back! Here's your property overview.</p>
      </div>
      <div class="header-right">
        <a href="#" class="user-profile" data-bs-toggle="modal" data-bs-target="#profileModal">
          <span>PK</span>
        </a>
      </div>
    </header>

    <div class="dashboard-content">
      <div class="toolbar">
        <input id="searchBox" type="search" placeholder="Search by city, address, or title..." />
        <select id="statusFilter">
          <option value="">All</option>
          <option value="AVAILABLE" selected>AVAILABLE</option>
          <option value="OCCUPIED">OCCUPIED</option>
        </select>
      </div>

      <div id="properties" class="grid"></div>
      <div id="emptyState" class="empty" style="display:none;">No properties found.</div>
    </div>
  </div>

  <!-- Profile Modal (Bootstrap) -->
  <div class="modal fade" id="profileModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Profile</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p><strong>Name:</strong> <span id="pmName">—</span></p>
          <p><strong>Email:</strong> <span id="pmEmail">—</span></p>
          <p><strong>Role:</strong> <span id="pmRole">—</span></p>
          <p><strong>Phone:</strong> <span id="pmPhone">—</span></p>
          <div id="pmTenantBlock" class="mt-3 d-none">
            <hr>
            <p><strong>Property:</strong> <span id="pmProperty">—</span></p>
            <p><strong>Rent:</strong> <span id="pmRent">—</span></p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" id="btnLogout">Logout</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Your existing scripts -->
  <script src="./js/tenantdashboard.js" defer></script>

  <!-- Inline: hydrate the profile modal using your APIs -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const modalEl = document.getElementById('profileModal');
      modalEl?.addEventListener('shown.bs.modal', hydrateProfileModal);

      document.getElementById('btnLogout')?.addEventListener('click', () => {
        localStorage.removeItem('token');
        window.location.href = '/index.html';
      });
    });

    function getToken(){ return localStorage.getItem('token'); }
    function authHeaders(){ const t=getToken(); return t?{ Authorization:`Bearer ${t}` }:{}; }
    async function getJSON(url,{allow401=false}={}){
      const res = await fetch(url,{ headers:{'Content-Type':'application/json',...authHeaders()}, credentials:'include' });
      if(!res.ok){ if(allow401 && res.status===401) return null; const text=await res.text().catch(()=>res.statusText); throw new Error(text); }
      const body = await res.json();
      return body?.data ?? body; // supports {ok:true,data:{...}} or plain object
    }
    function setText(id, v){ const el=document.getElementById(id); if(el) el.textContent = v ?? '—'; }

    async function hydrateProfileModal(){
      try{
        let user = await getJSON('/api/auth/me', { allow401:true });
        if(!user){
          const t = getToken();
          if(t && t.split('.').length>=2){
            const p = JSON.parse(atob(t.split('.')[1]));
            if(p?.email) user = { name:p.name, email:p.email, role:p.role, phone:p.phone ?? null };
          }
        }
        if(!user || !user.email) throw new Error('No identity');

        setText('pmName',  user.name || 'User');
        setText('pmEmail', user.email);
        setText('pmRole',  user.role || '—');

        let phone = user.phone ?? null;
        try{ const me = await getJSON('/api/customers/me/record'); phone = phone ?? me?.phone ?? null; }catch{}
        setText('pmPhone', phone);

        const tenantBlock = document.getElementById('pmTenantBlock');
        if(user.role === 'Tenant'){
          tenantBlock?.classList.remove('d-none');
          let property = user.property ?? null;
          let dueAmount = null, paid = null;
          try{
            const c = await getJSON('/api/customers/me/record');
            if(c){
              property = property ?? c.propertyName ?? c.property ?? null;
              if(typeof c.dueAmount === 'number') dueAmount = c.dueAmount;
              if(typeof c.paid === 'boolean')     paid = c.paid;
            }
          }catch{}
          if(!property){
            try{
              const list = await getJSON('/api/addtenants');
              const match = Array.isArray(list)
                ? list.find(x => (x.email || '').toLowerCase() === (user.email || '').toLowerCase())
                : null;
              if(match){
                property = match.propertyName || match.property || property;
                if(typeof match.rent === 'number') dueAmount = match.rent;
              }
            }catch{}
          }
          setText('pmProperty', property);
          const rentText = (dueAmount!=null ? `A$${Number(dueAmount).toFixed(2)}` : '—')
                         + (paid!=null ? ` • Paid: ${paid ? 'Yes' : 'No'}` : '');
          setText('pmRent', rentText);
        } else {
          tenantBlock?.classList.add('d-none');
        }
      }catch(e){
        console.error('[profile modal] failed:', e?.message||e);
      }
    }
  </script>

  <!-- ✅ Bootstrap 5 JS (needed for modal behavior) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
